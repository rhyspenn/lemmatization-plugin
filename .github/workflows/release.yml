name: lemmatization-plugin è‡ªåŠ¨å‘å¸ƒ

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  actions: read

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: æå–ç‰ˆæœ¬ä¿¡æ¯
      id: extract_info
      run: |
        # ä» info.json æå–æ’ä»¶ä¿¡æ¯
        PLUGIN_NAME=$(grep -o '"name"[[:space:]]*:[[:space:]]*"[^"]*"' src/info.json | cut -d'"' -f4)
        PLUGIN_VERSION=$(grep -o '"version"[[:space:]]*:[[:space:]]*"[^"]*"' src/info.json | cut -d'"' -f4)
        PLUGIN_IDENTIFIER=$(grep -o '"identifier"[[:space:]]*:[[:space:]]*"[^"]*"' src/info.json | cut -d'"' -f4)
        
        echo "plugin_name=$PLUGIN_NAME" >> $GITHUB_OUTPUT
        echo "plugin_version=$PLUGIN_VERSION" >> $GITHUB_OUTPUT
        echo "plugin_identifier=$PLUGIN_IDENTIFIER" >> $GITHUB_OUTPUT
        
        # åˆ›å»ºè¾“å‡ºæ–‡ä»¶å
        OUTPUT_NAME="${PLUGIN_IDENTIFIER}-${PLUGIN_VERSION}"
        echo "output_name=$OUTPUT_NAME" >> $GITHUB_OUTPUT
        
        echo "ğŸ“¦ æ’ä»¶åç§°: $PLUGIN_NAME"
        echo "ğŸ”– æ’ä»¶ç‰ˆæœ¬: $PLUGIN_VERSION"
        echo "ğŸ†” æ’ä»¶æ ‡è¯†: $PLUGIN_IDENTIFIER"
        
    - name: æ£€æŸ¥å¿…éœ€æ–‡ä»¶
      run: |
        echo "ğŸ” æ£€æŸ¥å¿…éœ€æ–‡ä»¶..."
        required_files=("info.json" "main.js")
        for file in "${required_files[@]}"; do
          if [ ! -f "src/$file" ]; then
            echo "âŒ é”™è¯¯: ç¼ºå°‘å¿…éœ€æ–‡ä»¶ $file"
            exit 1
          fi
        done
        echo "âœ… æ‰€æœ‰å¿…éœ€æ–‡ä»¶éƒ½å­˜åœ¨"
        
    - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      run: |
        echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
        find src -name ".DS_Store" -delete 2>/dev/null || true
        find src -name "*.tmp" -delete 2>/dev/null || true
        find src -name "Thumbs.db" -delete 2>/dev/null || true
        
    - name: æ‰“åŒ…æ’ä»¶
      run: |
        cd src
        echo "ğŸ“‹ å°†è¦æ‰“åŒ…çš„æ–‡ä»¶:"
        ls -la
        
        # åˆ›å»º zip æ–‡ä»¶
        zip -r "../${{ steps.extract_info.outputs.output_name }}.zip" . -x "*.DS_Store" "*.tmp" "Thumbs.db"
        
        # å°† .zip æ”¹åä¸º .bobplugin
        cd ..
        mv "${{ steps.extract_info.outputs.output_name }}.zip" "${{ steps.extract_info.outputs.output_name }}.bobplugin"
        
        echo "âœ… æ‰“åŒ…å®Œæˆ!"
        echo "ğŸ“ è¾“å‡ºæ–‡ä»¶: ${{ steps.extract_info.outputs.output_name }}.bobplugin"
        echo "ğŸ“Š æ–‡ä»¶å¤§å°: $(du -h "${{ steps.extract_info.outputs.output_name }}.bobplugin" | cut -f1)"
        
    - name: éªŒè¯æ‰“åŒ…å†…å®¹
      run: |
        echo "ğŸ” éªŒè¯æ‰“åŒ…å†…å®¹..."
        unzip -l "${{ steps.extract_info.outputs.output_name }}.bobplugin"
        
    - name: åˆ›å»º Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        name: ${{ steps.extract_info.outputs.plugin_name }} v${{ steps.extract_info.outputs.plugin_version }}
        body: |
          ## ğŸ‰ ${{ steps.extract_info.outputs.plugin_name }} v${{ steps.extract_info.outputs.plugin_version }}
          
          ### ğŸ“¦ å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ `${{ steps.extract_info.outputs.output_name }}.bobplugin` æ–‡ä»¶
          2. åŒå‡»æ–‡ä»¶å®‰è£…åˆ° Bob
          
          ### ğŸ”§ æ’ä»¶ä¿¡æ¯
          - **æ’ä»¶åç§°**: ${{ steps.extract_info.outputs.plugin_name }}
          - **æ’ä»¶ç‰ˆæœ¬**: ${{ steps.extract_info.outputs.plugin_version }}
          - **æ’ä»¶æ ‡è¯†**: ${{ steps.extract_info.outputs.plugin_identifier }}
          - **æœ€ä½ Bob ç‰ˆæœ¬**: 0.5.0
          
          ### ğŸ“ æ›´æ–°è¯´æ˜
          è¯·æŸ¥çœ‹æäº¤è®°å½•äº†è§£æœ¬ç‰ˆæœ¬çš„å…·ä½“æ›´æ–°å†…å®¹ã€‚
        files: |
          ${{ steps.extract_info.outputs.output_name }}.bobplugin
        draft: false
        prerelease: false
        
    - name: è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
      id: calc_hash
      run: |
        FILE_HASH=$(shasum -a 256 "${{ steps.extract_info.outputs.output_name }}.bobplugin" | cut -d' ' -f1)
        echo "file_hash=$FILE_HASH" >> $GITHUB_OUTPUT
        echo "ğŸ“ æ–‡ä»¶å“ˆå¸Œ: $FILE_HASH"
    
    - name: æ›´æ–° appcast.json
      run: |
        echo "âš ï¸ è¯·æ‰‹åŠ¨æ›´æ–° appcast.json ä¸­çš„ SHA256 å“ˆå¸Œå€¼:"
        echo "æ–‡ä»¶: ${{ steps.extract_info.outputs.output_name }}.bobplugin"
        echo "SHA256: ${{ steps.calc_hash.outputs.file_hash }}"
        echo "URL: https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ steps.extract_info.outputs.output_name }}.bobplugin"
        
    - name: å®Œæˆæç¤º
      run: |
        echo "ğŸ‰ lemmatization-plugin æ‰“åŒ…å’Œå‘å¸ƒæˆåŠŸ!"
        echo "ğŸ’¡ æç¤º:"
        echo "   - æ’ä»¶å·²ä¸Šä¼ åˆ° GitHub Release"
        echo "   - ç”¨æˆ·å¯ä»¥ä» Release é¡µé¢ä¸‹è½½ .bobplugin æ–‡ä»¶"
        echo "   - åŒå‡» .bobplugin æ–‡ä»¶å³å¯å®‰è£…åˆ° Bob"
